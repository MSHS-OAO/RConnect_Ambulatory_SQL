---
title: "main"
output: html_document
date: '2022-09-09'
---

```{r}
library(glue)
library(odbc)
library(tidyverse)
library(DBI)
library(pool)

date_1 <- "2021-01-01"
date_2 <- Sys.Date() - 1
reg_exp <- "\\[(.*?)\\]"

### Maping Table
ambulatory_mapping_drop <- glue("DROP TABLE AMBULATORY_MAPPING")
ambulatory_mapping_query <- glue("CREATE TABLE AMBULATORY_MAPPING AS
SELECT b.CAMPUS, b.CAMPUS_SPECIALTY, b.DEPARTMENT_OLD, b.DEPARTMENT, b.DEPARTMENT_ID, d.LAST_ARRIVED
FROM(
SELECT a.*, regexp_replace(DEPARTMENT_OLD,'_DEACTIVATED|X_','') AS DEPARTMENT,
CASE CAMPUS_OLD WHEN 'MSDD' THEN 'MSDMG' ELSE CAMPUS_OLD END AS CAMPUS
FROM(
    SELECT distinct DEP_RPT_GRP_SEVENTEEN  AS CAMPUS_OLD, DEPT_SPECIALTY_NAME  AS CAMPUS_SPECIALTY, DEPARTMENT_NAME AS DEPARTMENT_OLD, DEPARTMENT_ID
    FROM MV_DM_PATIENT_ACCESS where DERIVED_STATUS_DESC = 'Arrived'
    ) a
   ) b 
    LEFT JOIN
    (SELECT c.*
       FROM(
          SELECT DEPARTMENT_ID, max(APPT_DTTM) as LAST_ARRIVED
          FROM MV_DM_PATIENT_ACCESS where DERIVED_STATUS_DESC = 'Arrived'
          GROUP BY DEPARTMENT_ID
          ) c
          ) d
          on b.DEPARTMENT_ID= d.DEPARTMENT_ID")

ambulatory_mapping_index <- glue("CREATE index amb_mapping_index on AMBULATORY_MAPPING (CAMPUS, CAMPUS_SPECIALTY, DEPARTMENT, DEPARTMENT_ID)")
ambulatory_mapping_grant <- glue("GRANT SELECT on AMBULATORY_MAPPING to kweons01")

###Provider mapping table
ambulatory_provider_mapping <- glue("CREATE TABLE AMBULATORY_PROVIDER_MAPPING AS
SELECT distinct TRIM(TRAILING FROM REGEXP_REPLACE(PROV_NAME_WID, '{reg_exp}', '')) AS Provider, PROV_ID FROM MV_DM_PATIENT_ACCESS
WHERE CONTACT_DATE BETWEEN TO_DATE('2021-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
            AND TO_DATE(current_date - 1)")
            
drop_ambulatory_provider_mapping <- glue("DROP TABLE AMBULATORY_PROVIDER_MAPPING")

drop_access_query <- glue("DROP TABLE AMBULATORY_ACCESS")


###Main Ambulatory Table
access_query <- glue("CREATE TABLE AMBULATORY_ACCESS AS
SELECT e.*, CASE e.ACCESS_CENTER WHEN 'Y' THEN 'Access Center' ELSE e.APPT_SOURCE_MAP_OTHER END AS Appt_Source_New
FROM(
SELECT d.*, APPT_DATE_YEAR - DAYS_SUBTRACT AS APPT_WEEK, NVL(d.APPT_SOURCE_MAP, 'Other') AS APPT_SOURCE_MAP_OTHER
FROM(
SELECT c.*,
EXTRACT(year from c.APPT_DTTM) Appt_Year,
                       CONCAT(TO_CHAR(c.APPT_DTTM, 'HH24'), ':00') APPT_TM_HR,
                       TO_CHAR(c.APPT_DTTM, 'MON') AS Appt_Month,
                       TO_CHAR(c.APPT_DTTM, 'yyyy-mm') AS Appt_Month_Year,
                       TO_CHAR(c.APPT_MADE_DTTM, 'yyyy-mm') AS Appt_Made_Month_Year,
                       TO_CHAR(c.APPT_DTTM, 'mm-dd') AS Appt_Date,
                       LEAST(c.VISIT_END_DTTM, c.CHECKOUT_DTTM) AS min_of_checkout_visit,
                       (LEAST(c.VISIT_END_DTTM, c.CHECKOUT_DTTM)  - c.CHECKIN_DTTM)*24*60 AS cycleTime,
                       (c.ROOMIN_DTTM - c.CHECKIN_DTTM) * 24*60 AS checkinToRoomin,
                       (c.CHECKOUT_DTTM - c.VISIT_END_DTTM)*24*60 AS visitEndToCheckout,
                       (c.Appt_DTTM - c.APPT_MADE_DTTM) AS Wait_Time,
                       (c.APPT_DTTM - c.APPT_CANCEL_DTTM) AS Lead_Days,
                       TRIM( ',' FROM c.DEPARTMENT||','||c.PROV_NAME_WID||','||c.MRN||','||c.APPT_DTTM ) AS uniqueID,
                       CASE WHEN c.NEW_PT = 4 THEN 'NEW' ELSE 'ESTABLISHED' END AS NEW_PT2,
                       REGEXP_SUBSTR(c.CLASS_PT, 'NEW') AS NEW_PT3,
                       CONCAT('Q',TO_CHAR(c.APPT_DTTM, 'Q')) AS APPT_QUARTER
    FROM(
     SELECT i.CAMPUS, i.CAMPUS_SPECIALTY, i.DEPARTMENT,d.*, b.holiday, f.DAYS_SUBTRACT, h.APPT_SOURCE_NEW AS APPT_SOURCE_MAP 
    FROM(
 SELECT a.PROV_NAME_WID, a.PROV_ID, a.DEPARTMENT_ID AS Department_ID, a.REFERRING_PROV_NAME_WID AS Refferring_Provider,
                             a.MRN, a.PAT_NAME AS Patient_Name, a.ZIP_CODE, a.BIRTH_DATE, a.FINCLASS AS Coverage,
                             a.APPT_MADE_DTTM, a.APPT_DTTM, a.PRC_NAME AS APPT_TYPE, a.APPT_LENGTH AS APPT_DUR, a.DERIVED_STATUS_DESC AS APPT_STATUS,
                             a.APPT_CANC_DTTM AS APPT_CANCEL_DTTM, a.CANCEL_REASON_NAME AS CANCEL_REASON,
                             a.SIGNIN_DTTM, a.PAGED_DTTM, a.CHECKIN_DTTM, a.ARVL_LIST_REMOVE_DTTM AS ARRIVAL_REMOVE_DTTM,
                             a.ROOMED_DTTM AS ROOMIN_DTTM, a.FIRST_ROOM_ASSIGN_DTTM AS ROOM_ASSIGNED_DTTM, 
                             a.PHYS_ENTER_DTTM AS PROVIDERIN_DTTM, a.VISIT_END_DTTM, a.CHECKOUT_DTTM,
                             a.TIME_IN_ROOM_MINUTES AS TIMEIN_ROOM, a.CYCLE_TIME_MINUTES AS CYCLE_TIME, a.LOS_NAME AS CLASS_PT, a.LOS_CODE,
                             a.DEP_RPT_GRP_THIRTYONE AS CADENCE, a.APPT_ENTRY_USER_NAME_WID AS APPT_SOURCE, 
                             a.ACCESS_CENTER_SCHEDULED_YN AS ACCESS_CENTER, a.VISIT_METHOD, a.VISIT_PROV_STAFF_RESOURCE_C,
                             a.PRIMARY_DX_CODE, a.ENC_CLOSED_CHARGE_STATUS, a.Y_ENC_COSIGN_TIME, a.Y_ENC_CLOSE_TIME, a.Y_ENC_OPEN_TIME, a.NPI, a.VISIT_GROUP_NUM AS NEW_PT, 
                             a.PAT_ENC_CSN_ID, a.VISITPLAN, a.ATTRIB_BILL_AREA,
                             trunc(a.APPT_DTTM) AS Appt_Date_Year,
                             TO_CHAR(a.APPT_DTTM, 'DY') AS APPT_DAY,
                             TRIM(TRAILING FROM REGEXP_REPLACE(a.PROV_NAME_WID, '{reg_exp}', '')) AS Provider,
                             CASE a.VISIT_PROV_STAFF_RESOURCE_C WHEN 1 THEN 'Provider' ELSE 'Resource' END AS Resources,
                             trunc(a.APPT_MADE_DTTM) AS APPT_MADE_DATE_YEAR
FROM MV_DM_PATIENT_ACCESS a
        WHERE a.CONTACT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                        AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
                             OR a.APPT_MADE_DTTM BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                        AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
                    ) d
                    LEFT JOIN holidays b on d.Appt_Date_Year = b.dates
                    LEFT JOIN SUBTRACT_DAYS f on d.APPT_DAY = f.WEEKDAY
                    LEFT JOIN AMBULATORY_APPT_SOURCE h on d.APPT_SOURCE = h.APPT_SOURCE
                    LEFT JOIN AMBULATORY_MAPPING i on d.DEPARTMENT_ID = i.DEPARTMENT_ID
                    ) c
                    )d
                    ) e")
access_index <- glue("CREATE index filter_index on AMBULATORY_ACCESS (CAMPUS, CAMPUS_SPECIALTY, DEPARTMENT, RESOURCES, PROVIDER, VISIT_METHOD, APPT_TYPE, APPT_DATE_YEAR, APPT_DAY)")
appt_status_index <- glue("CREATE index status_index on AMBULATORY_ACCESS (APPT_STATUS)")
access_index_npr <- glue("CREATE index filter_index_access on AMBULATORY_ACCESS (APPT_MADE_DTTM, PROVIDER, APPT_TYPE, DEPARTMENT, CAMPUS_SPECIALTY)")


###Table specifically for global filters
drop_ambulatory_filters_query <- glue("DROP TABLE AMBULATORY_FILTERS")
ambulatory_filters_query <- glue("CREATE TABLE AMBULATORY_FILTERS AS
SELECT DISTINCT CAMPUS, CAMPUS_SPECIALTY, DEPARTMENT, PROVIDER, RESOURCES, VISIT_METHOD, APPT_TYPE FROM AMBULATORY_ACCESS")


## Slot Table
drop_slot_query <- glue("DROP TABLE AMBULATORY_SLOT")
slot_query <- glue("CREATE TABLE AMBULATORY_SLOT AS
SELECT c.CAMPUS, c.CAMPUS_SPECIALTY, c.DEPARTMENT AS DEPARTMENT_NAME, b.*, b.APPT_DATE_YEAR - f.DAYS_SUBTRACT AS APPT_WEEK
FROM (
    SELECT a.DEPARTMENT_ID,
    a.PROVIDER_NAME AS PROVIDER, a.EPIC_PROV_ID AS PROV_ID,
               a.SLOT_BEGIN_TIME AS APPT_DTTM, a.NUM_APTS_SCHEDULED, a.SLOT_LENGTH,
               a.AVAIL_MINUTES, a.ARRIVED_MINUTES,
               a.CANCELED_MINUTES, a.NOSHOW_MINUTES, a.LEFTWOBEINGSEEN_MINUTES,
               a.AVAIL_SLOTS, a.BOOKED_SLOTS, a.ARRIVED_SLOTS, a.CANCELED_SLOTS,
               a.NOSHOW_SLOTS, a.LEFTWOBEINGSEEN_SLOTS, a.ORG_REG_OPENINGS,
               a.ORG_OVBK_OPENINGS, a.PRIVATE_YN, a.DAY_UNAVAIL_YN, a.TIME_UNAVAIL_YN,
               a.DAY_HELD_YN, a.TIME_HELD_YN, a.OUTSIDE_TEMPLATE_YN, a.VISIT_PROV_STAFF_RESOURCE_C AS RESOURCES,
               a.AVAIL_MINUTES/60 AS AVAILABLE_HOURS,
               a.BOOKED_MINUTES/60 AS BOOKED_HOURS,
               a.ARRIVED_MINUTES/60 AS ARRIVED_HOURS,
               a.CANCELED_MINUTES/60 AS CANCELED_HOURS,
               (a.NOSHOW_MINUTES + a.LEFTWOBEINGSEEN_MINUTES)/60 AS NO_SHOW_HOURS,
               (a.BOOKED_MINUTES + a.CANCELED_MINUTES) AS BOOKED_MINUTES,
                --TO_CHAR(trunc(TO_DATE(a.SLOT_BEGIN_TIME, 'yyyy-mm-dd HH24:MI:SS'))) AS Appt_Date_Year,
                trunc(a.SLOT_BEGIN_TIME) AS Appt_Date_Year,
                TO_CHAR(a.SLOT_BEGIN_TIME, 'yyyy-mm') AS Appt_Month_Year,
                EXTRACT(year from a.SLOT_BEGIN_TIME) Appt_Year,
                TO_CHAR(a.SLOT_BEGIN_TIME, 'MON') AS Appt_Month,
                TO_CHAR(a.SLOT_BEGIN_TIME, 'DY') AS APPT_DAY,
                TO_CHAR(trunc(a.SLOT_BEGIN_TIME, 'HH24'), 'HH24:MI') AS APPT_TM_HR,
                TO_CHAR(a.SLOT_BEGIN_TIME, 'HH24:MI') AS TIME,
                'In Person' AS VISIT_METHOD
        FROM Y_DM_BOOKED_FILLED_RATE a
        WHERE a.CONTACT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                        AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
                        ) b
    LEFT JOIN AMBULATORY_MAPPING c on b.DEPARTMENT_ID = c.DEPARTMENT_ID  
    LEFT JOIN SUBTRACT_DAYS f on b.APPT_DAY = f.WEEKDAY")
    
    slot_index <- glue("CREATE index slot_index on AMBULATORY_SLOT (DEPARTMENT_NAME, APPT_DATE_YEAR, CAMPUS_SPECIALTY)")



###Population View
drop_population_query <- glue("DROP VIEW AMBULATORY_POPULATION")
population_query <- glue("CREATE VIEW AMBULATORY_POPULATION AS 
SELECT g.*
FROM(
SELECT e.*,
CASE 
   WHEN (e.ZIP_CODE_LAYER_A = 'Out of NYS'  AND e.ZIP_CODE_LAYER_B is NULL)
     THEN
         CASE
           WHEN e.STATES = 'NJ' THEN 'New Jersey'
           WHEN e.STATES = 'CT' THEN 'Connecticut'
           WHEN e.STATES = 'FL' THEN 'Florida'
           WHEN e.STATES = 'PA' THEN 'Pennsylvania'
           ELSE 'Other'
           END
    ELSE   e.ZIP_CODE_LAYER_B  
 END AS NEW_ZIP_CODE_LAYER_B,
 CASE 
   WHEN (e.ZIP_CODE_LAYER_A is NULL  AND 
        ( e.STATES is NOT NULL OR e.STATES != 'NY')
        )
        THEN 'Out of NYS'
        ELSE e.ZIP_CODE_LAYER_A
END AS NEW_ZIP_CODE_LAYER_A
FROM(
SELECT b.*, c.ZIP_CODE_LAYER_A, c.ZIP_CODE_LAYER_B, c.ZIP_CODE_LAYER_C, d.CITY, d.STATES, d.LATITUDE, d.LONGITUDE
FROM(
SELECT a.*,
 SUBSTR(a.ZIP_CODE, 1, 5) AS NEW_ZIP 
FROM AMBULATORY_ACCESS a 
    ) b
    LEFT JOIN ZIP_CODE_LAYER c ON b.NEW_ZIP = c.ZIP_CODE AND b.APPT_STATUS = 'Arrived'
    LEFT JOIN ZIP_CITY_STATE d ON b.NEW_ZIP = d.ZIP AND b.APPT_STATUS = 'Arrived'
       ) e
       
       )g")
population_grant <- glue("GRANT SELECT ON AMBULATORY_POPULATION to KWEONS01")



###Query Execution
  tryCatch({
        conn <- dbConnect(drv = odbc(), "OAO Cloud DB", timeout = 30)
        dbBegin(conn)
            if(dbExistsTable(conn, "AMBULATORY_MAPPING")){
          dbExecute(conn, ambulatory_mapping_drop) 
            }
        dbExecute(conn, ambulatory_mapping_query)
        dbExecute(conn, ambulatory_mapping_index)
        dbExecute(conn, ambulatory_mapping_grant)
        
        if(dbExistsTable(conn, "AMBULATORY_PROVIDER_MAPPING")){
          dbExecute(conn, drop_ambulatory_provider_mapping) 
         }
         dbExecute(conn, ambulatory_provider_mapping)

        
        if(dbExistsTable(conn, "AMBULATORY_ACCESS")){
          dbExecute(conn, drop_access_query) 
        }
        dbExecute(conn, access_query)
        dbExecute(conn, access_index)
        dbExecute(conn, appt_status_index)
        dbExecute(conn, access_index_npr)

        
        if(dbExistsTable(conn, "AMBULATORY_FILTERS")){
          dbExecute(conn, drop_ambulatory_filters_query)
        }
        dbExecute(conn, ambulatory_filters_query)
        
        if(dbExistsTable(conn, "AMBULATORY_SLOT")){
          dbExecute(conn, drop_slot_query)
        }
        dbExecute(conn, slot_query)
        dbExecute(conn, slot_index)

        
        if(dbExistsTable(conn, "AMBULATORY_POPULATION")){
          dbExecute(conn, drop_population_query)
        }
        dbExecute(conn, population_query)
        dbExecute(conn, population_grant)
        
        dbCommit(conn)
        dbDisconnect(conn)
        print("success")

  },
  error = function(err){
    print(err)
    dbRollback(conn)
    dbDisconnect(conn)
  })

#source("utilization.R")

## Grouped Access Table
access_summary_drop <- glue("DROP TABLE AMBULATORY_ACCESS_SUMMARY_TABLE")
access_summary_query <- glue("CREATE TABLE AMBULATORY_ACCESS_SUMMARY_TABLE AS
SELECT
    CAMPUS,
    CAMPUS_SPECIALTY,
    DEPARTMENT,
    RESOURCES,
    VISIT_METHOD,
    APPT_DATE_YEAR,
    APPT_STATUS,
    PROVIDER,
    APPT_TYPE,
    TO_CHAR(APPT_DATE_YEAR, 'yyyy-mm') AS Appt_Month_Year,
    TO_CHAR(APPT_DATE_YEAR, 'DY') AS APPT_DAY,
    NEW_PT2,
    NEW_PT3
    COUNT(*) AS total_appts
FROM (VILLEA04.AMBULATORY_ACCESS)
GROUP BY
    CAMPUS,
    CAMPUS_SPECIALTY,
    DEPARTMENT,
    RESOURCES,
    VISIT_METHOD,
    APPT_DATE_YEAR,
    APPT_STATUS,
    PROVIDER,
    APPT_TYPE,
    APPT_DAY,
    NEW_PT2,
    NEW_PT3")


###Grouped NPR Table
access_npr_summary_drop <- glue("DROP TABLE AMBULATORY_ACCESS_NPR_SUMMARY_TABLE")
access_npr_summary <- glue("CREATE TABLE AMBULATORY_ACCESS_NPR_SUMMARY_TABLE AS
SELECT b.*, COUNT(*) AS total_appts, TO_CHAR(b.APPT_MADE_DATE_YEAR, 'yyyy-mm') AS APPT_MADE_MONTH_YEAR
FROM(
        SELECT
            a.CAMPUS,
            a.CAMPUS_SPECIALTY,
            a.DEPARTMENT,
            a.RESOURCES,
            a.VISIT_METHOD,
            trunc(a.APPT_MADE_DTTM) AS APPT_MADE_DATE_YEAR,
            a.APPT_STATUS,
            a.PROVIDER,
            a.APPT_TYPE,
            TO_CHAR(trunc(a.APPT_MADE_DTTM), 'DY') AS APPT_DAY,
            a.NEW_PT2
            a.NEW_PT3
        FROM (VILLEA04.AMBULATORY_ACCESS) a
    ) b
GROUP BY
    b.CAMPUS,
    b.CAMPUS_SPECIALTY,
    b.DEPARTMENT,
    b.RESOURCES,
    b.VISIT_METHOD,
    b.APPT_MADE_DATE_YEAR,
    b.APPT_STATUS,
    b.PROVIDER,
    b.APPT_TYPE,
    b.APPT_DAY,
    b.NEW_PT2,
    b.NEW_PT3")


## Grouped Table execution
  tryCatch({
        poolcon_upt <- dbConnect(drv = odbc(), "OAO Cloud DB Staging", timeout = 30)
        dbBegin(poolcon_upt)
            if(dbExistsTable(poolcon_upt, "AMBULATORY_ACCESS_SUMMARY_TABLE")){
          dbExecute(poolcon_upt, access_summary_drop) 
            }
          dbExecute(poolcon_upt, access_summary_query) 
            if(dbExistsTable(poolcon_upt, "AMBULATORY_ACCESS_NPR_SUMMARY_TABLE")){
          dbExecute(poolcon_upt, access_npr_summary_drop) 
            }
          dbExecute(poolcon_upt, access_npr_summary) 


        
        dbCommit(poolcon_upt)
        dbDisconnect(poolcon_upt)
        print("success")

  },
  error = function(err){
    print("error staging")
    dbRollback(poolcon_upt)
    dbDisconnect(poolcon_upt)
  })

```

