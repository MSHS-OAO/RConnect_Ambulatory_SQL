---
title: "main"
output: html_document
date: '2022-09-09'
---

```{r}
library(glue)
library(odbc)
library(tidyverse)
library(DBI)
library(pool)

date_1 <- "2019-01-01"
date_2 <- "2022-12-31"
reg_exp <- "\\[(.*?)\\]"


###Main Ambulatory Table
access_query <- glue("CREATE TABLE AMBULATORY_ACCESS_LAITH AS
SELECT e.*, CASE WHEN TO_CHAR(APPT_DTTM, 'HH24') >= 12 THEN 'PM' ELSE 'AM' END AS AM_PM, nvl(e.NEW_PT3_RAW, 'ESTABLISHED') AS NEW_PT3, nvl(e.SCHEDULE_GROUPING, 'Other') AS SCHEDULE_GROUPING_MAPPED,
nvl(e.CAMPUS_NEW, 'NA') AS CAMPUS, nvl(e.CAMPUS_SPECIALTY_NEW, 'NA') AS CAMPUS_SPECIALTY,
CASE e.ACCESS_CENTER WHEN 'Y' THEN 'Access Center' ELSE e.APPT_SOURCE_MAP_OTHER END AS Appt_Source_New,
CASE WHEN (CHECKINTOROOMIN >= 0.0 AND CHECKINTOROOMIN < 30.0) THEN '0' WHEN NOT (CHECKINTOROOMIN >= 0.0 AND CHECKINTOROOMIN < 30.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 30.0 AND CHECKINTOROOMIN < 60.0) THEN '30' WHEN NOT (CHECKINTOROOMIN >= 30.0 AND CHECKINTOROOMIN < 60.0) THEN (CASE WHEN (CHECKINTOROOMIN >=  60.0 AND CHECKINTOROOMIN < 90.0) THEN '60' WHEN NOT (CHECKINTOROOMIN >=  60.0 AND CHECKINTOROOMIN < 90.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 90.0 AND CHECKINTOROOMIN < 120.0) THEN '90' WHEN NOT (CHECKINTOROOMIN >= 90.0 AND CHECKINTOROOMIN < 120.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 120.0 AND CHECKINTOROOMIN < 150.0) THEN '120' WHEN NOT (CHECKINTOROOMIN >= 120.0 AND CHECKINTOROOMIN < 150.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 150.0 AND CHECKINTOROOMIN <180.0) THEN '150' WHEN NOT (CHECKINTOROOMIN >= 150.0 AND CHECKINTOROOMIN <180.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 180.0 AND CHECKINTOROOMIN < 210.0) THEN '180' WHEN NOT (CHECKINTOROOMIN >= 180.0 AND CHECKINTOROOMIN < 210.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 210.0 AND CHECKINTOROOMIN < 240.0) THEN '210' WHEN NOT (CHECKINTOROOMIN >= 210.0 AND CHECKINTOROOMIN < 240.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 240.0 AND CHECKINTOROOMIN < 270.0) THEN '240' WHEN NOT (CHECKINTOROOMIN >= 240.0 AND CHECKINTOROOMIN < 270.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 270.0 AND CHECKINTOROOMIN < 300.0) THEN '270' WHEN NOT (CHECKINTOROOMIN >= 270.0 AND CHECKINTOROOMIN < 300.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 300.0 AND CHECKINTOROOMIN < 330.0) THEN '300' WHEN NOT (CHECKINTOROOMIN >= 300.0 AND CHECKINTOROOMIN < 330.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 330.0 AND CHECKINTOROOMIN > 360.0) THEN '330' WHEN NOT (CHECKINTOROOMIN >= 330.0 AND CHECKINTOROOMIN > 360.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 360.0 AND CHECKINTOROOMIN < 390.0) THEN '360' WHEN NOT (CHECKINTOROOMIN >= 360.0 AND CHECKINTOROOMIN < 390.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 390.0 AND CHECKINTOROOMIN < 420.0) THEN '390' WHEN NOT (CHECKINTOROOMIN >= 390.0 AND CHECKINTOROOMIN < 420.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 420.0 AND CHECKINTOROOMIN < 450.0) THEN '420' WHEN NOT (CHECKINTOROOMIN >= 420.0 AND CHECKINTOROOMIN < 450.0) THEN (CASE WHEN (CHECKINTOROOMIN >= 450.0 AND CHECKINTOROOMIN < 480.0) THEN '450' WHEN NOT (CHECKINTOROOMIN >= 450.0 AND CHECKINTOROOMIN < 480.0) THEN '480' END) END) END) END) END) END) END) END) END) END) END) END) END) END) END) END AS bin_roomin,
  CASE WHEN (CYCLETIME >= 0.0 AND CYCLETIME < 30.0) THEN '0' WHEN NOT (CYCLETIME >= 0.0 AND CYCLETIME < 30.0) THEN (CASE WHEN (CYCLETIME >= 30.0 AND CYCLETIME < 60.0) THEN '30' WHEN NOT (CYCLETIME >= 30.0 AND CYCLETIME < 60.0) THEN (CASE WHEN (CYCLETIME >=  60.0 AND CYCLETIME < 90.0) THEN '60' WHEN NOT (CYCLETIME >=  60.0 AND CYCLETIME < 90.0) THEN (CASE WHEN (CYCLETIME >= 90.0 AND CYCLETIME < 120.0) THEN '90' WHEN NOT (CYCLETIME >= 90.0 AND CYCLETIME < 120.0) THEN (CASE WHEN (CYCLETIME >= 120.0 AND CYCLETIME < 150.0) THEN '120' WHEN NOT (CYCLETIME >= 120.0 AND CYCLETIME < 150.0) THEN (CASE WHEN (CYCLETIME >= 150.0 AND CYCLETIME <180.0) THEN '150' WHEN NOT (CYCLETIME >= 150.0 AND CYCLETIME <180.0) THEN (CASE WHEN (CYCLETIME >= 180.0 AND CYCLETIME < 210.0) THEN '180' WHEN NOT (CYCLETIME >= 180.0 AND CYCLETIME < 210.0) THEN (CASE WHEN (CYCLETIME >= 210.0 AND CYCLETIME < 240.0) THEN '210' WHEN NOT (CYCLETIME >= 210.0 AND CYCLETIME < 240.0) THEN (CASE WHEN (CYCLETIME >= 240.0 AND CYCLETIME < 270.0) THEN '240' WHEN NOT (CYCLETIME >= 240.0 AND CYCLETIME < 270.0) THEN (CASE WHEN (CYCLETIME >= 270.0 AND CYCLETIME < 300.0) THEN '270' WHEN NOT (CYCLETIME >= 270.0 AND CYCLETIME < 300.0) THEN (CASE WHEN (CYCLETIME >= 300.0 AND CYCLETIME < 330.0) THEN '300' WHEN NOT (CYCLETIME >= 300.0 AND CYCLETIME < 330.0) THEN (CASE WHEN (CYCLETIME >= 330.0 AND CYCLETIME > 360.0) THEN '330' WHEN NOT (CYCLETIME >= 330.0 AND CYCLETIME > 360.0) THEN (CASE WHEN (CYCLETIME >= 360.0 AND CYCLETIME < 390.0) THEN '360' WHEN NOT (CYCLETIME >= 360.0 AND CYCLETIME < 390.0) THEN (CASE WHEN (CYCLETIME >= 390.0 AND CYCLETIME < 420.0) THEN '390' WHEN NOT (CYCLETIME >= 390.0 AND CYCLETIME < 420.0) THEN (CASE WHEN (CYCLETIME >= 420.0 AND CYCLETIME < 450.0) THEN '420' WHEN NOT (CYCLETIME >= 420.0 AND CYCLETIME < 450.0) THEN (CASE WHEN (CYCLETIME >= 450.0 AND CYCLETIME < 480.0) THEN '450' WHEN NOT (CYCLETIME >= 450.0 AND CYCLETIME < 480.0) THEN '480' END) END) END) END) END) END) END) END) END) END) END) END) END) END) END) END AS bin_cycle,
      CASE WHEN (ROOMINTOVISITEND >= 0.0 AND ROOMINTOVISITEND < 30.0) THEN '0' WHEN NOT (ROOMINTOVISITEND >= 0.0 AND ROOMINTOVISITEND < 30.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 30.0 AND ROOMINTOVISITEND < 60.0) THEN '30' WHEN NOT (ROOMINTOVISITEND >= 30.0 AND ROOMINTOVISITEND < 60.0) THEN (CASE WHEN (ROOMINTOVISITEND >=  60.0 AND ROOMINTOVISITEND < 90.0) THEN '60' WHEN NOT (ROOMINTOVISITEND >=  60.0 AND ROOMINTOVISITEND < 90.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 90.0 AND ROOMINTOVISITEND < 120.0) THEN '90' WHEN NOT (ROOMINTOVISITEND >= 90.0 AND ROOMINTOVISITEND < 120.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 120.0 AND ROOMINTOVISITEND < 150.0) THEN '120' WHEN NOT (ROOMINTOVISITEND >= 120.0 AND ROOMINTOVISITEND < 150.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 150.0 AND ROOMINTOVISITEND <180.0) THEN '150' WHEN NOT (ROOMINTOVISITEND >= 150.0 AND ROOMINTOVISITEND <180.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 180.0 AND ROOMINTOVISITEND < 210.0) THEN '180' WHEN NOT (ROOMINTOVISITEND >= 180.0 AND ROOMINTOVISITEND < 210.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 210.0 AND ROOMINTOVISITEND < 240.0) THEN '210' WHEN NOT (ROOMINTOVISITEND >= 210.0 AND ROOMINTOVISITEND < 240.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 240.0 AND ROOMINTOVISITEND < 270.0) THEN '240' WHEN NOT (ROOMINTOVISITEND >= 240.0 AND ROOMINTOVISITEND < 270.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 270.0 AND ROOMINTOVISITEND < 300.0) THEN '270' WHEN NOT (ROOMINTOVISITEND >= 270.0 AND ROOMINTOVISITEND < 300.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 300.0 AND ROOMINTOVISITEND < 330.0) THEN '300' WHEN NOT (ROOMINTOVISITEND >= 300.0 AND ROOMINTOVISITEND < 330.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 330.0 AND ROOMINTOVISITEND > 360.0) THEN '330' WHEN NOT (ROOMINTOVISITEND >= 330.0 AND ROOMINTOVISITEND > 360.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 360.0 AND ROOMINTOVISITEND < 390.0) THEN '360' WHEN NOT (ROOMINTOVISITEND >= 360.0 AND ROOMINTOVISITEND < 390.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 390.0 AND ROOMINTOVISITEND < 420.0) THEN '390' WHEN NOT (ROOMINTOVISITEND >= 390.0 AND ROOMINTOVISITEND < 420.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 420.0 AND ROOMINTOVISITEND < 450.0) THEN '420' WHEN NOT (ROOMINTOVISITEND >= 420.0 AND ROOMINTOVISITEND < 450.0) THEN (CASE WHEN (ROOMINTOVISITEND >= 450.0 AND ROOMINTOVISITEND < 480.0) THEN '450' WHEN NOT (ROOMINTOVISITEND >= 450.0 AND ROOMINTOVISITEND < 480.0) THEN '480' END) END) END) END) END) END) END) END) END) END) END) END) END) END) END) END AS bin_roomin_visit_end




FROM(
SELECT d.*, APPT_DATE_YEAR - DAYS_SUBTRACT AS APPT_WEEK, NVL(d.APPT_SOURCE_MAP, 'Other') AS APPT_SOURCE_MAP_OTHER,
                       (d.min_of_checkout_visit - d.ROOMIN_DTTM)*24*60 AS ROOMINTOVISITEND

FROM(
SELECT c.*,
EXTRACT(year from c.APPT_DTTM) Appt_Year,
                       CONCAT(TO_CHAR(c.APPT_DTTM, 'HH24'), ':00') APPT_TM_HR,
                       TO_CHAR(c.APPT_DTTM, 'MON') AS Appt_Month,
                       TO_CHAR(c.APPT_DTTM, 'yyyy-mm') AS Appt_Month_Year,
                       TO_CHAR(c.APPT_MADE_DTTM, 'yyyy-mm') AS Appt_Made_Month_Year,
                       TO_CHAR(c.APPT_DTTM, 'mm-dd') AS Appt_Date,
                       LEAST(COALESCE(c.VISIT_END_DTTM, c.CHECKOUT_DTTM), COALESCE(c.CHECKOUT_DTTM, c.VISIT_END_DTTM)) AS min_of_checkout_visit,
                       (c.ROOMIN_DTTM - c.CHECKIN_DTTM) * 24*60 AS checkinToRoomin,
                       (c.CHECKOUT_DTTM - c.VISIT_END_DTTM)*24*60 AS visitEndToCheckout,
                       (c.Appt_DTTM - c.APPT_MADE_DTTM) AS Wait_Time,
                       (c.APPT_DTTM - c.APPT_CANCEL_DTTM) AS Lead_Days,
                       TRIM( ',' FROM c.DEPARTMENT||','||c.PROV_NAME_WID||','||c.MRN||','||c.APPT_DTTM ) AS uniqueID,
                       CASE WHEN c.NEW_PT = 4 THEN 'NEW' ELSE 'ESTABLISHED' END AS NEW_PT2,
                       REGEXP_SUBSTR(c.CLASS_PT, 'NEW') AS NEW_PT3_RAW,
                       CONCAT('Q',TO_CHAR(c.APPT_DTTM, 'Q')) AS APPT_QUARTER,
                       CONCAT('Q',TO_CHAR(c.APPT_MADE_DTTM, 'Q')) AS APPT_MADE_QUARTER,
                        EXTRACT(year from c.APPT_MADE_DTTM) AS Appt_MADE_Year,
                        TO_CHAR(c.APPT_MADE_DTTM, 'mm-dd') AS Appt_Made_Date,
                        TO_CHAR(c.APPT_MADE_DTTM, 'MON') AS Appt_MAde_Month
    FROM(
     SELECT i.CAMPUS AS CAMPUS_NEW, i.CAMPUS_SPECIALTY AS CAMPUS_SPECIALTY_NEW, i.DEPARTMENT,d.*, b.holiday, f.DAYS_SUBTRACT, h.APPT_SOURCE_NEW AS APPT_SOURCE_MAP, j.SCHEDULE_GROUPING
    FROM(
 SELECT a.PROV_NAME_WID, a.PROV_ID, a.DEPARTMENT_ID AS Department_ID, a.REFERRING_PROV_NAME_WID AS Refferring_Provider, a.CYCLE_TIME_MINUTES AS cycleTime,
                             a.MRN, a.PAT_NAME AS Patient_Name, a.ZIP_CODE, a.BIRTH_DATE, a.FINCLASS AS Coverage,
                             a.APPT_MADE_DTTM, a.APPT_DTTM, a.PRC_NAME AS APPT_TYPE, a.APPT_LENGTH AS APPT_DUR, a.DERIVED_STATUS_DESC AS APPT_STATUS,
                             a.APPT_CANC_DTTM AS APPT_CANCEL_DTTM, a.CANCEL_REASON_NAME AS CANCEL_REASON,
                             a.SIGNIN_DTTM, a.PAGED_DTTM, a.CHECKIN_DTTM, a.ARVL_LIST_REMOVE_DTTM AS ARRIVAL_REMOVE_DTTM,
                             a.ROOMED_DTTM AS ROOMIN_DTTM, a.FIRST_ROOM_ASSIGN_DTTM AS ROOM_ASSIGNED_DTTM, 
                             a.PHYS_ENTER_DTTM AS PROVIDERIN_DTTM, a.VISIT_END_DTTM, a.CHECKOUT_DTTM,
                             a.TIME_IN_ROOM_MINUTES AS TIMEIN_ROOM, a.CYCLE_TIME_MINUTES AS CYCLE_TIME, a.LOS_NAME AS CLASS_PT, a.LOS_CODE,
                             a.DEP_RPT_GRP_THIRTYONE AS CADENCE, a.APPT_ENTRY_USER_NAME_WID AS APPT_SOURCE, 
                             a.ACCESS_CENTER_SCHEDULED_YN AS ACCESS_CENTER, a.VISIT_METHOD, a.VISIT_PROV_STAFF_RESOURCE_C,
                             a.PRIMARY_DX_CODE, a.ENC_CLOSED_CHARGE_STATUS, a.Y_ENC_COSIGN_TIME, a.Y_ENC_CLOSE_TIME, a.Y_ENC_OPEN_TIME, a.NPI, a.VISIT_GROUP_NUM AS NEW_PT, 
                             a.PAT_ENC_CSN_ID, a.VISITPLAN, a.ATTRIB_BILL_AREA,
                             TRIM(LOWER(a.SCHED_METHOD)) AS SCHED_METHOD_TRIMMED,
                             trunc(a.APPT_DTTM) AS Appt_Date_Year,
                             TO_CHAR(a.APPT_DTTM, 'DY') AS APPT_DAY,
                             TRIM(TRAILING FROM REGEXP_REPLACE(a.PROV_NAME_WID, '{reg_exp}', '')) AS Provider,
                             CASE a.VISIT_PROV_STAFF_RESOURCE_C WHEN 1 THEN 'Provider' ELSE 'Resource' END AS Resources,
                             trunc(a.APPT_MADE_DTTM) AS APPT_MADE_DATE_YEAR,
                             a.OVERBOOKED_YN
FROM MV_DM_PATIENT_ACCESS a
        WHERE a.CONTACT_DATE BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                        AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
                             OR a.APPT_MADE_DTTM BETWEEN TO_DATE('{date_1} 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
                        AND TO_DATE('{date_2} 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
                    ) d
                    LEFT JOIN holidays b on d.Appt_Date_Year = b.dates
                    LEFT JOIN SUBTRACT_DAYS f on d.APPT_DAY = f.WEEKDAY
                    LEFT JOIN AMBULATORY_APPT_SOURCE h on d.APPT_SOURCE = h.APPT_SOURCE
                    LEFT JOIN AMBULATORY_MAPPING i on d.DEPARTMENT_ID = i.DEPARTMENT_ID
                    LEFT JOIN AMBULATORY_SCHED_METHOD j on d.SCHED_METHOD_TRIMMED = LOWER(j.SCHED_METHOD)
                    ) c
                    )d
                    ) e")




###Query Execution
  tryCatch({
        conn <- dbConnect(drv = odbc(), "OAO Cloud DB", timeout = 30)
        dbBegin(conn)
        dbExecute(conn, access_query)

        dbCommit(conn)
        dbDisconnect(conn)
        print("success")

  },
  error = function(err){
    print(err)
    dbRollback(conn)
    dbDisconnect(conn)
  })




```

