---
title: "Utilization Test"
output: html_document
date: '2022-10-04'
---



```{r cars}
library(tidyverse)
library(odbc)
library(lubridate)
library(readxl)
library(glue)

print(Sys.time())
# conn <- dbConnect(odbc(), "OAO Cloud DB")
# 
# access <- tbl(conn, "AMBULATORY_ACCESS")
# 
# utilization_query <- glue("SELECT * FROM(
#     SELECT CAMPUS, CAMPUS_SPECIALTY, DEPARTMENT, RESOURCES, PROVIDER, VISIT_METHOD, APPT_DATE_YEAR, APPT_MONTH_YEAR, APPT_YEAR, APPT_WEEK, APPT_DAY, HOLIDAY, APPT_DUR, APPT_DTTM, APPT_STATUS
#     FROM AMBULATORY_ACCESS WHERE APPT_STATUS = 'Arrived'
#     UNION
#     SELECT CAMPUS, CAMPUS_SPECIALTY, DEPARTMENT, RESOURCES, PROVIDER, VISIT_METHOD, APPT_DATE_YEAR, APPT_MONTH_YEAR, APPT_YEAR, APPT_WEEK, APPT_DAY, HOLIDAY, APPT_DUR, APPT_DTTM, APPT_STATUS
#     FROM AMBULATORY_ACCESS WHERE APPT_STATUS = 'No Show'
#     UNION
#     SELECT CAMPUS, CAMPUS_SPECIALTY, DEPARTMENT, RESOURCES, PROVIDER, VISIT_METHOD, APPT_DATE_YEAR, APPT_MONTH_YEAR, APPT_YEAR, APPT_WEEK, APPT_DAY, HOLIDAY, APPT_DUR, APPT_DTTM, APPT_STATUS
#     FROM AMBULATORY_ACCESS WHERE APPT_STATUS IN ('Canceled', 'Bumped', 'Rescheduled') AND LEAD_DAYS = 0
# )
# WHERE APPT_DTTM BETWEEN TO_DATE(TRUNC(SYSDATE - 1), 'YYYY-MM-DD HH24:MI:SS')
# 				AND TO_DATE(TRUNC(SYSDATE) - 1/(24*60*60), 'YYYY-MM-DD HH24:MI:SS')")
# 
# data.hour.scheduled <- dbGetQuery(conn, utilization_query)
# data.hour.scheduled <- data.hour.scheduled %>% mutate(Appt.Start = as.POSIXct(APPT_DTTM, format = "%H:%M"))
# data.hour.scheduled <- data.hour.scheduled %>% mutate(Appt.End = as.POSIXct(Appt.Start + APPT_DUR*60, format = "%H:%M"))
# data.hour.scheduled <- data.hour.scheduled %>% mutate(Appt.Date = as.Date(APPT_DTTM))
# 
# 
# 
# #Create new columns
# hours <- c("0", "1", "2", "3", "4", "5", "6", "7","8","9",
#            "10","11","12","13","14","15","16","17","18","19",
#            "20", "21", "22", "23")
# 
# 
# ##Fill new columns with NA
# data.hour.scheduled[, hours] <- NA
# 
# 
# 
# 
# data.hour.scheduled <- data.hour.scheduled %>% pivot_longer(hours, names_to = "hour", values_to = "min") %>% mutate(hour = as.numeric(hour))
# 
# 
# data.hour.scheduled <- data.hour.scheduled %>% group_by(DEPARTMENT, PROV_NAME_WID, MRN, APPT_DTTM) %>% filter(hour(Appt.Start) <= hour)
# data.hour.scheduled <- data.hour.scheduled %>% group_by(DEPARTMENT, PROV_NAME_WID, MRN, APPT_DTTM) %>% filter(hour(Appt.End) >= hour)
# 
# 
# data.hour.scheduled <- data.hour.scheduled %>% mutate(min = ifelse(hour(Appt.Start) == hour(Appt.End), difftime(Appt.End, Appt.Start, units = "mins"), 
#                                                                    ifelse(hour(Appt.Start) == hour, difftime(ceiling_date(Appt.Start, "hour", change_on_boundary = T), Appt.Start),
#                                                                           ifelse(hour(Appt.End) == hour,  difftime(Appt.End, floor_date(Appt.End, "hour"), "mins"),
#                                                                                  ifelse(hour %in% hour(Appt.Start):hour(Appt.End) , 60, NA
#                                                                                         )
#                                                                                  )
#                                                                           )
#                                                                    )
#                                                       )
# data.hour.scheduled <- data.hour.scheduled %>% mutate(min = ifelse(min == 0, NA, min))
# ##Pviot data on hour and rename columns to HH:MM format
# print(Sys.time())
# print(data.hour.scheduled)
```

